sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageBox","sap/ui/core/util/File","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/ui/thirdparty/jquery","sap/ui/export/Spreadsheet","sap/ui/export/library"],(e,t,o,a,r,jQuery,s,n)=>{"use strict";const i=n.EdmType;return e.extend("nsdecimals.moduledecimals.controller.View1",{onInit(){this.getView().setModel(new r({csvData:[],fileName:"",dadosProcessados:false}),"csvModel")},onValidateNumericInput:function(e){const t=e.getSource();let o=t.getValue();if(o.length>4){o=o.substring(0,4);t.setValue(o)}const a=/^[0-9]{1},[0-9]{2}$/;const r=/^([0-9]{0,1}(,([0-9]{0,2}))?)?$/;if(a.test(o)){t.setValueState("Success")}else if(r.test(o)){t.setValueState("None")}else{t.setValueState("Error");t.setValueStateText("Digite um valor no formato 0,00")}this._formatDecimalInput(e)},_formatDecimalInput:function(e){const t=e.getSource();let o=t.getValue();if(/^[0-9]$/.test(o)&&!o.includes(",")){o=o+",";t.setValue(o)}if(o.includes(",")){const e=o.split(",");if(e.length>1&&e[1].length>2){e[1]=e[1].substring(0,2);o=e[0]+","+e[1];t.setValue(o)}}if(o.includes(",")){const e=o.split(",");if(e[0].length>1){e[0]=e[0].substring(e[0].length-1);o=e[0]+","+e[1];t.setValue(o)}}},onShowHelp:function(){t.information("O arquivo deve estar no formato CSV com as seguintes colunas:\n\n"+"- NF_ID: Identificador da nota fiscal (10 dígitos numéricos)\n"+"- NUM_ITEM: Número do item (até 6 dígitos numéricos)\n\n"+"Exemplo de conteúdo do arquivo CSV:\n\n"+"NF_ID,NUM_ITEM\n"+"1234567890,123456\n"+"0987654321,654321\n\n"+"O separador pode ser vírgula (,) ou ponto-e-vírgula (;).",{title:"Ajuda - Formato do Arquivo CSV"})},handleTypeMissmatch:function(e){t.error("Apenas arquivos CSV são permitidos.")},handleFileSelect:function(e){var t=e.getSource();var o=e.getParameter("files")&&e.getParameter("files")[0];if(!o){return}var a=this.getView().getModel("csvModel");a.setProperty("/fileName",o.name);this._readCSVFile(o)},_readCSVFile:function(e){var o=this;var r=new FileReader;r.onload=function(e){try{var r=e.target.result;var s=r.split(/\r\n|\n/);if(s.length>0){s.shift()}var n=[];var i=false;var l=[];s.forEach(function(e,t){if(e.trim()===""){return}var o=e.split(";");if(o.length<2){o=e.split(",")}if(o.length>=2){var a=o[0].trim();var r=o[1].trim();var s=/^\d{10}$/.test(a);var c=/^\d{1,6}$/.test(r);if(s&&c){var d=r.padStart(6,"0");n.push({nfId:a,numItem:d,vlOprSaida:"",vlrOprEntrada:"",vlItem:"",vlMerc:"",vlTotalDocumento:"",base:"",outrosBase:"",baseExcluida:""})}else{i=true;l.push("Linha "+(t+2)+": "+(s?"":"NF_ID inválido")+(c?"":(s?"":" e ")+"NUM_ITEM inválido"))}}});var c=o.getView().getModel("csvModel");c.setProperty("/csvData",n);if(i){var d="Algumas linhas contêm dados inválidos:\n"+l.join("\n");if(l.length>10){d=l.slice(0,10).join("\n")+"\n...(mais "+(l.length-10)+" linhas com erro)"}t.warning("Dados com problemas de formatação\n\n"+d)}else if(n.length===0){t.warning("Nenhum dado válido encontrado no arquivo.")}else{a.show("Arquivo processado com sucesso. "+n.length+" linhas válidas encontradas.",{duration:5e3,width:"30em"})}}catch(e){t.error("Erro ao processar o arquivo: "+e.message);console.error("Erro ao processar o arquivo CSV:",e)}};r.onerror=function(e){t.error("Erro ao ler o arquivo: "+(e.target.error?e.target.error.name:"Erro desconhecido"))};r.readAsText(e)},onProcessar:function(){var e=this.getView();var o=e.byId("numericInput").getValue();var r=e.byId("rbMore").getSelected();var s=e.getModel("csvModel");var n=s.getProperty("/csvData");if(!/^[0-9]{1},[0-9]{2}$/.test(o)){t.error("O valor do ajuste decimal deve estar no formato 0,00");return}var i=parseFloat(o.replace(",","."));if(!r){i=-i}a.show("Processando dados com ajuste "+(r?"positivo":"negativo")+" de "+o,{duration:2e3});var l=new sap.m.BusyDialog({title:"Processando",text:"Obtendo dados complementares...",showCancelButton:false});l.open();var c=function(e){if(e===null||e===undefined||isNaN(e))return"";return e.toFixed(2).replace(".",",")};var d=function(e){if(typeof e!=="string"||e.trim()==="")return 0;return parseFloat(e.replace(",","."))};this._loadMockData().then(function(e){var a=n.map(function(t){var o=e.items.find(function(e){return e.nfId===t.nfId&&e.numItem===t.numItem});if(o){var a=d(o.vlOprSaida)+i;var r=d(o.vlrOprEntrada)+i;var s=d(o.vlItem)+i;var n=d(o.vlMerc)+i;var l=d(o.vlTotalDocumento)+i;var u=d(o.base)+i;var p=d(o.outrosBase)+i;var v=d(o.baseExcluida)+i;return{nfId:t.nfId,numItem:t.numItem,vlOprSaida:c(a),vlrOprEntrada:c(r),vlItem:c(s),vlMerc:c(n),vlTotalDocumento:c(l),base:c(u),outrosBase:c(p),baseExcluida:c(v)}}else{return t}});s.setProperty("/csvData",a);s.setProperty("/dadosProcessados",true);var u=0;var p=0;a.forEach(function(e){if(e.vlOprSaida){u++}else{p++}});l.close();t.success("Processamento concluído com sucesso!\n\n"+"Ajuste aplicado: "+(r?"+":"-")+o+"\n"+"Total de registros processados: "+u+"\n"+(p>0?"Registros não encontrados no banco de dados: "+p:""),{title:"Processamento Concluído"})}).catch(function(e){l.close();t.error("Ocorreu um erro ao processar os dados: "+e)})},_loadMockData:function(){return new Promise(function(e,t){$.ajax({url:"./model/mockData.json",dataType:"json",success:function(t){e(t)},error:function(e,o,a){t("Erro ao carregar dados complementares: "+a)}})})},onExportToExcel:function(){var e=this.getView();var o=e.getModel("csvModel");var r=o.getProperty("/csvData");if(!r||r.length===0){a.show("Não há dados para exportar.");return}var n=new sap.m.BusyDialog({title:"Exportando",text:"Gerando arquivo Excel...",showCancelButton:false});n.open();try{var l=[{label:"NF_ID",property:"nfId",type:i.String},{label:"NUM_ITEM",property:"numItem",type:i.String},{label:"VL_OPR_SAIDA",property:"vlOprSaida",type:i.String},{label:"VLR_OPR_ENTRADA",property:"vlrOprEntrada",type:i.String},{label:"VL_ITEM",property:"vlItem",type:i.String},{label:"VL_MERC",property:"vlMerc",type:i.String},{label:"VL_TOTAL_DOCUMENTO",property:"vlTotalDocumento",type:i.String},{label:"BASE",property:"base",type:i.String},{label:"OUTROS_BASE",property:"outrosBase",type:i.String},{label:"BASE_EXCLUIDA",property:"baseExcluida",type:i.String}];var c={workbook:{columns:l,context:{sheetName:"Dados Ajustados",title:"Dados Ajustados com Decimais"}},dataSource:r,fileName:"dados_ajustados_"+this._getFormattedDate()+".xlsx"};var d=new s(c);d.build().then(function(){n.close();a.show("Arquivo exportado com sucesso!",{duration:3e3})}).catch(function(e){n.close();t.error("Erro ao exportar o arquivo: "+e)}).finally(function(){d.destroy()})}catch(e){n.close();console.error("Erro ao exportar para Excel:",e);t.error("Erro ao exportar o arquivo: "+e.message)}},_getFormattedDate:function(){var e=new Date;return e.getFullYear()+("0"+(e.getMonth()+1)).slice(-2)+("0"+e.getDate()).slice(-2)+"_"+("0"+e.getHours()).slice(-2)+("0"+e.getMinutes()).slice(-2)},onSave:function(){var e=this;var t=this.getView();var o=t.getModel("csvModel");var a=o.getProperty("/csvData");var r=new sap.m.BusyDialog({title:"Salvando",text:"Salvando dados no banco...",showCancelButton:false});r.open();setTimeout(function(){r.close();var t=new sap.m.Dialog({title:"Salvamento Concluído",type:"Message",state:"Success",content:[new sap.m.VBox({items:[new sap.m.Text({text:"Os dados foram salvos com sucesso no banco de dados!"}).addStyleClass("sapUiMediumMarginBottom"),new sap.m.Text({text:"Total de registros salvos: "+a.length}),new sap.m.Text({text:"Deseja fazer o download dos dados para referência?"}).addStyleClass("sapUiMediumMarginTop")]})],beginButton:new sap.m.Button({text:"Download Excel",icon:"sap-icon://excel-attachment",press:function(){e.onExportToExcel();t.close();e._resetApplication()}}),endButton:new sap.m.Button({text:"Fechar",press:function(){t.close();e._resetApplication()}}),afterClose:function(){t.destroy()}});t.open()},2e3)},_resetApplication:function(){var e=this.getView().getModel("csvModel");e.setProperty("/csvData",[]);e.setProperty("/fileName","");e.setProperty("/dadosProcessados",false);var t=this.byId("fileUploader");if(t){t.clear()}a.show("Aplicação reiniciada. Você pode importar um novo arquivo.",{duration:3e3})}})});
//# sourceMappingURL=View1.controller.js.map